{% extends "admin/admin_base.html" %}
{% block admin_content %}
<div class="container mt-4">
  <h2>Ustawienia e-mail</h2>
  <form method="POST" enctype="multipart/form-data">
    {{ form.csrf_token }}
    <div class="row g-2">
      <div class="col-md-4">
        {{ form.server.label(class="form-label") }}
        {{ form.server(class="form-control") }}
      </div>
      <div class="col-md-2">
        {{ form.port.label(class="form-label") }}
        {{ form.port(class="form-control") }}
      </div>
      <div class="col-md-2">
        {{ form.encryption.label(class="form-label") }}
        {{ form.encryption(class="form-select") }}
      </div>
      <div class="col-md-3">
        {{ form.login.label(class="form-label") }}
        {{ form.login(class="form-control") }}
      </div>
      <div class="col-md-3">
        {{ form.password.label(class="form-label") }}
        {{ form.password(class="form-control") }}
      </div>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-md-6">
        {{ form.sender.label(class="form-label") }}
        {{ form.sender(class="form-control") }}
        <div class="form-text">{{ form.sender.description }}</div>
      </div>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-md-6">
        {{ form.test_recipient.label(class="form-label") }}
        {{ form.test_recipient(class="form-control") }}
      </div>
    </div>
    <div class="mb-3 mt-2">
      {{ form.registration_template.label(class="form-label") }}
      {{ form.registration_template(id="registration_template") }}
      <div id="registration_editor" class="quill-wrapper" style="height:200px;"></div>
      <textarea id="registration_editor_textarea" class="form-control d-none" style="height:200px;"></textarea>
      <div class="mt-2">
        {% for var in ['{first_name}', '{last_name}', '{training}', '{cancel_link}', '{date}', '{location}', '{logo}'] %}
        <button type="button" class="btn btn-sm btn-secondary insert-var" data-editor="registration_editor" data-value="{{ var }}">{{ var }}</button>
        {% endfor %}
        <button type="button" class="btn btn-sm btn-outline-primary ms-2 preview-btn" data-template="registration" data-editor="registration_editor">Podgląd</button>
        <div class="form-check form-switch d-inline-block ms-2">
          <input class="form-check-input html-toggle" type="checkbox" role="switch" id="registration_html_toggle" data-editor="registration_editor">
          <label class="form-check-label" for="registration_html_toggle">Edytuj HTML</label>
        </div>
      </div>
    </div>
    <div class="row g-4 mt-3">
      <div class="col-md-6">
        <h5 class="mb-3">Załączniki (dorośli)</h5>
        <div class="mb-3">
          {{ form.adult_attachments.label(class="form-label") }}
          {{ form.adult_attachments(class_="form-control", multiple=True) }}
          <div class="form-text">Możesz dodać wiele plików jednocześnie.</div>
        </div>
        <div class="mb-2">
          <h6 class="fw-semibold">{{ form.remove_adult_attachments.label.text }}</h6>
          {% if adult_attachments %}
          <ul class="list-group">
            {% for checkbox in form.remove_adult_attachments %}
            {% set meta = adult_attachments[loop.index0] %}
            {% set display_name = meta.get('original_name') or meta.get('filename') %}
            {% set content_type = meta.get('content_type') %}
            {% set size = meta.get('size') %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div>{{ display_name }}</div>
                <div class="small text-muted">
                  {{ content_type or 'application/octet-stream' }}{% if size is not none %} • {{ size }} B{% endif %}
                </div>
              </div>
              <div class="form-check m-0">
                {{ checkbox(class_="form-check-input") }}
                <label class="form-check-label" for="{{ checkbox.id }}">Usuń</label>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted mb-0">Brak zapisanych załączników.</p>
          {% endif %}
        </div>
      </div>
      <div class="col-md-6">
        <h5 class="mb-3">Załączniki (nieletni)</h5>
        <div class="mb-3">
          {{ form.minor_attachments.label(class="form-label") }}
          {{ form.minor_attachments(class_="form-control", multiple=True) }}
          <div class="form-text">Dodaj pliki dla zapisów nieletnich.</div>
        </div>
        <div class="mb-2">
          <h6 class="fw-semibold">{{ form.remove_minor_attachments.label.text }}</h6>
          {% if minor_attachments %}
          <ul class="list-group">
            {% for checkbox in form.remove_minor_attachments %}
            {% set meta = minor_attachments[loop.index0] %}
            {% set display_name = meta.get('original_name') or meta.get('filename') %}
            {% set content_type = meta.get('content_type') %}
            {% set size = meta.get('size') %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div>{{ display_name }}</div>
                <div class="small text-muted">
                  {{ content_type or 'application/octet-stream' }}{% if size is not none %} • {{ size }} B{% endif %}
                </div>
              </div>
              <div class="form-check m-0">
                {{ checkbox(class_="form-check-input") }}
                <label class="form-check-label" for="{{ checkbox.id }}">Usuń</label>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted mb-0">Brak zapisanych załączników.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="mb-3">
      {{ form.cancellation_template.label(class="form-label") }}
      {{ form.cancellation_template(id="cancellation_template") }}
      <div id="cancellation_editor" class="quill-wrapper" style="height:200px;"></div>
      <textarea id="cancellation_editor_textarea" class="form-control d-none" style="height:200px;"></textarea>
      <div class="mt-2">
        {% for var in ['{first_name}', '{last_name}', '{training}', '{cancel_link}', '{date}', '{location}', '{logo}'] %}
        <button type="button" class="btn btn-sm btn-secondary insert-var" data-editor="cancellation_editor" data-value="{{ var }}">{{ var }}</button>
        {% endfor %}
        <button type="button" class="btn btn-sm btn-outline-primary ms-2 preview-btn" data-template="cancellation" data-editor="cancellation_editor">Podgląd</button>
        <div class="form-check form-switch d-inline-block ms-2">
          <input class="form-check-input html-toggle" type="checkbox" role="switch" id="cancellation_html_toggle" data-editor="cancellation_editor">
          <label class="form-check-label" for="cancellation_html_toggle">Edytuj HTML</label>
        </div>
      </div>
    </div>
  {{ form.submit(class="btn btn-primary") }}
  {{ form.send_test(class="btn btn-secondary ms-2", formaction=url_for('admin.test_email'), formmethod='post') }}
  </form>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body"></div>
    </div>
  </div>
</div>
{% endblock %}
