{% extends "admin/admin_base.html" %}
{% block extra_head %}
{{ super() }}
{% endblock %}

{% block admin_content %}
<div class="admin-page-header">
  <h2><i class="bi bi-whatsapp" style="color: #25D366;"></i>Czat WhatsApp</h2>
</div>

<div class="wa-chat-container" id="chatContainer">
    <!-- Left: Chat list -->
    <div class="chat-list">
      <div class="new-chat-section">
        <div class="input-group">
          <input type="text" id="newChatPhone" placeholder="Nr telefonu (np. 697495755)">
          <button onclick="openNewChat()">Nowy</button>
        </div>
      </div>
      <div class="chat-search">
        <input type="text" id="chatSearch" placeholder="Szukaj..." oninput="filterChats()">
      </div>
      <div id="chatListItems">
        <div class="loading-spinner">≈Åadowanie czat√≥w...</div>
      </div>
    </div>

    <!-- Right: Chat panel -->
    <div class="chat-panel" id="chatPanel">
      <div class="chat-empty" id="chatEmpty">
        <div class="text-center">
          <div style="font-size: 64px;">üí¨</div>
          <p class="mt-2">Wybierz czat lub rozpocznij nowy</p>
        </div>
      </div>

      <div id="chatView" style="display: none; flex: 1; display: none; flex-direction: column; height: 100%;">
        <div class="chat-header" id="chatHeader">
          <div class="chat-avatar" id="chatAvatar">?</div>
          <div>
            <div class="fw-bold" id="chatName">-</div>
            <div class="small text-muted" id="chatPhone">-</div>
          </div>
        </div>
        <div class="chat-messages" id="chatMessages">
          <div class="loading-spinner">≈Åadowanie wiadomo≈õci...</div>
        </div>
        <div class="chat-input-area">
          <textarea id="msgInput" rows="1" placeholder="Napisz wiadomo≈õƒá..." onkeydown="handleMsgKey(event)"></textarea>
          <button onclick="sendMessage()" title="Wy≈õlij">
            <i class="bi bi-send-fill"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const CSRF_TOKEN = '{{ csrf_token() }}';
let allChats = [];
let activeChatId = null;
let messagesInterval = null;

// Format timestamp
function fmtTime(ts) {
  if (!ts) return '';
  const d = new Date(ts * 1000);
  const now = new Date();
  const isToday = d.toDateString() === now.toDateString();
  if (isToday) return d.toLocaleTimeString('pl-PL', {hour: '2-digit', minute: '2-digit'});
  return d.toLocaleDateString('pl-PL', {day: '2-digit', month: '2-digit'}) + ' ' + d.toLocaleTimeString('pl-PL', {hour: '2-digit', minute: '2-digit'});
}

function getInitial(name) {
  if (!name) return '?';
  // If it's a phone number
  if (name.startsWith('+')) return 'üì±';
  return name.charAt(0).toUpperCase();
}

// Load chats
async function loadChats() {
  try {
    const r = await fetch('/admin/whatsapp/api/chats');
    allChats = await r.json();
    renderChats(allChats);
  } catch(e) {
    document.getElementById('chatListItems').innerHTML = '<div class="p-3 text-danger">B≈ÇƒÖd ≈Çadowania czat√≥w</div>';
  }
}

function renderChats(chats) {
  const container = document.getElementById('chatListItems');
  if (!chats.length) {
    container.innerHTML = '<div class="p-3 text-muted">Brak czat√≥w</div>';
    return;
  }
  container.innerHTML = chats.map(c => {
    const isActive = c.id === activeChatId ? 'active' : '';
    const initial = getInitial(c.name);
    const preview = c.lastMessage ? c.lastMessage.substring(0, 40) + (c.lastMessage.length > 40 ? '...' : '') : '';
    const time = fmtTime(c.timestamp);
    const unread = c.unreadCount > 0 ? `<div class="unread-badge">${c.unreadCount}</div>` : '';
    return `<div class="chat-list-item ${isActive}" onclick="openChat('${c.id}', '${(c.name||'').replace(/'/g, "\\'")}', '${c.phone||''}')">
      <div class="chat-avatar">${initial}</div>
      <div class="chat-info">
        <div class="chat-name">${c.name || c.phone || c.id}</div>
        <div class="chat-preview">${preview}</div>
      </div>
      <div>
        <div class="chat-time">${time}</div>
        ${unread}
      </div>
    </div>`;
  }).join('');
}

function filterChats() {
  const q = document.getElementById('chatSearch').value.toLowerCase();
  if (!q) { renderChats(allChats); return; }
  const filtered = allChats.filter(c => 
    (c.name || '').toLowerCase().includes(q) || 
    (c.phone || '').includes(q) ||
    (c.id || '').includes(q)
  );
  renderChats(filtered);
}

// Open chat
async function openChat(chatId, name, phone) {
  activeChatId = chatId;
  
  // Update header
  document.getElementById('chatEmpty').style.display = 'none';
  const chatView = document.getElementById('chatView');
  chatView.style.display = 'flex';
  document.getElementById('chatAvatar').textContent = getInitial(name);
  document.getElementById('chatName').textContent = name || phone || chatId;
  document.getElementById('chatPhone').textContent = phone || chatId;
  
  // Highlight in list
  document.querySelectorAll('.chat-list-item').forEach(el => el.classList.remove('active'));
  event && event.currentTarget && event.currentTarget.classList.add('active');

  // Load messages
  await loadMessages(chatId);

  // Auto-refresh messages
  if (messagesInterval) clearInterval(messagesInterval);
  messagesInterval = setInterval(() => loadMessages(chatId, true), 10000);
}

async function loadMessages(chatId, silent) {
  const container = document.getElementById('chatMessages');
  if (!silent) container.innerHTML = '<div class="loading-spinner">≈Åadowanie...</div>';

  try {
    const r = await fetch(`/admin/whatsapp/api/messages/${encodeURIComponent(chatId)}`);
    const msgs = await r.json();
    
    const wasAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 50;

    container.innerHTML = msgs.map(m => {
      const cls = m.fromMe ? 'sent' : 'received';
      const time = fmtTime(m.timestamp);
      const body = escapeHtml(m.body || '');
      const ticks = m.fromMe ? ackTicks(m.ack) : '';
      return `<div class="msg-bubble ${cls}"><div>${body}</div><div class="msg-time">${time}${ticks}</div></div>`;
    }).join('');

    if (!silent || wasAtBottom) {
      container.scrollTop = container.scrollHeight;
    }
  } catch(e) {
    if (!silent) container.innerHTML = '<div class="p-3 text-danger">B≈ÇƒÖd ≈Çadowania wiadomo≈õci</div>';
  }
}

function ackTicks(ack) {
  // 0=pending, 1=sent(server), 2=delivered, 3=read
  if (ack >= 3) return ' <span class="msg-ticks ack-3">‚úì‚úì</span>';
  if (ack >= 2) return ' <span class="msg-ticks ack-2">‚úì‚úì</span>';
  if (ack >= 1) return ' <span class="msg-ticks ack-1">‚úì</span>';
  return ' <span class="msg-ticks">‚åõ</span>';
}

function escapeHtml(t) {
  const div = document.createElement('div');
  div.textContent = t;
  return div.innerHTML.replace(/\n/g, '<br>');
}

// Send message
async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text || !activeChatId) return;

  input.value = '';
  input.style.height = 'auto';

  // Optimistic add
  const container = document.getElementById('chatMessages');
  const now = Math.floor(Date.now() / 1000);
  container.innerHTML += `<div class="msg-bubble sent"><div>${escapeHtml(text)}</div><div class="msg-time">${fmtTime(now)} ‚è≥</div></div>`;
  container.scrollTop = container.scrollHeight;

  try {
    await fetch('/admin/whatsapp/api/send', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN},
      body: JSON.stringify({chatId: activeChatId, message: text})
    });
    // Reload to get confirmed message
    setTimeout(() => loadMessages(activeChatId, true), 1500);
  } catch(e) {
    alert('B≈ÇƒÖd wysy≈Çania wiadomo≈õci');
  }
}

// New chat
function openNewChat() {
  let phone = document.getElementById('newChatPhone').value.trim();
  if (!phone) return;
  
  // Normalize
  phone = phone.replace(/[\s\-]/g, '');
  if (phone.length === 9) phone = '48' + phone;
  if (phone.startsWith('+')) phone = phone.substring(1);
  
  const chatId = phone + '@c.us';
  openChat(chatId, '+' + phone, '+' + phone);
  document.getElementById('newChatPhone').value = '';
}

function handleMsgKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
  // Auto-resize textarea
  const ta = e.target;
  setTimeout(() => {
    ta.style.height = 'auto';
    ta.style.height = Math.min(ta.scrollHeight, 120) + 'px';
  }, 0);
}

// Init
loadChats().then(() => {
  // Auto-open chat if ?phone= parameter present
  const params = new URLSearchParams(window.location.search);
  const phone = params.get('phone');
  if (phone) {
    let digits = phone.replace(/[\s\-\+]/g, '');
    if (digits.length === 9) digits = '48' + digits;
    if (!digits.startsWith('48') && digits.length < 11) digits = '48' + digits;
    // Find chat by matching phone digits (phone field is "+48XXXXXXXXX")
    const existing = allChats.find(c => c.phone && c.phone.replace(/\D/g, '') === digits);
    if (existing) {
      openChat(existing.id, existing.name, existing.phone);
    } else {
      // No existing chat ‚Äì use @c.us format for new conversations
      const chatId = digits + '@c.us';
      openChat(chatId, '+' + digits, '+' + digits);
    }
  }
});
// Refresh chat list every 30s
setInterval(loadChats, 30000);
</script>
{% endblock %}
