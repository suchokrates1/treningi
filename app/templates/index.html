{% extends "base.html" %}
{% block extra_head %}
<style>
  /* Hero Banner */
  .hero-banner {
    position: relative;
    background: linear-gradient(135deg, rgba(102, 51, 153, 0.85), rgba(30, 60, 114, 0.9)),
                url("https://images.unsplash.com/photo-1554068865-24cecd4e34b8?w=1600&q=80") center/cover no-repeat;
    color: white;
    padding: 4rem 2rem;
    margin: -1rem -0.75rem 2rem -0.75rem;
    border-radius: 0 0 1.5rem 1.5rem;
    text-align: center;
    box-shadow: 0 10px 40px rgba(102, 51, 153, 0.3);
  }
  .hero-banner h1 {
    font-size: 2.75rem;
    font-weight: 800;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  }
  .hero-banner p {
    font-size: 1.25rem;
    max-width: 600px;
    margin: 0 auto 1.5rem auto;
    opacity: 0.95;
  }
  .hero-badge {
    display: inline-block;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    padding: 0.75rem 1.75rem;
    border-radius: 2rem;
    font-size: 1rem;
    border: 1px solid rgba(255,255,255,0.3);
    animation: pulse 2s infinite;
  }
  .hero-badge i { color: #ffc107; }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
  }

  /* Section Headers */
  .section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .section-header h2 {
    margin: 0;
    font-weight: 700;
    color: #663399;
  }
  .section-header::after {
    content: "";
    flex: 1;
    height: 3px;
    background: linear-gradient(90deg, #663399, transparent);
    border-radius: 2px;
  }
  body.dark-mode .section-header h2 { color: #a855f7; }
  body.dark-mode .section-header::after { background: linear-gradient(90deg, #a855f7, transparent); }

  /* Filters */
  .filters-card {
    background: white;
    border-radius: 1rem;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  }
  body.dark-mode .filters-card {
    background: #2a2a40;
  }
  .filters-card .form-select, .filters-card .form-check-label {
    font-size: 0.9rem;
  }
  .filter-label {
    font-weight: 600;
    font-size: 0.85rem;
    color: #663399;
    margin-bottom: 0.25rem;
  }
  body.dark-mode .filter-label { color: #a855f7; }

  /* Month Tabs */
  .month-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }
  .month-tab {
    background: white;
    border: 2px solid #e0e0e0;
    color: #666;
    padding: 0.75rem 1.25rem;
    border-radius: 2rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .month-tab:hover {
    border-color: #663399;
    color: #663399;
  }
  .month-tab.active {
    background: linear-gradient(135deg, #663399, #1e3c72);
    border-color: transparent;
    color: white;
    box-shadow: 0 4px 15px rgba(102, 51, 153, 0.3);
  }
  .month-tab .count {
    background: rgba(0,0,0,0.1);
    padding: 0.15rem 0.5rem;
    border-radius: 1rem;
    font-size: 0.75rem;
  }
  .month-tab.active .count {
    background: rgba(255,255,255,0.2);
  }
  body.dark-mode .month-tab {
    background: #2a2a40;
    border-color: #444;
    color: #aaa;
  }
  body.dark-mode .month-tab:hover {
    border-color: #a855f7;
    color: #a855f7;
  }
  body.dark-mode .month-tab.active {
    background: linear-gradient(135deg, #663399, #1e3c72);
    color: white;
  }

  /* Month Content */
  .month-content {
    display: none;
  }
  .month-content.active {
    display: block;
  }

  /* Training Cards */
  .training-card {
    background: white;
    border-radius: 1rem;
    padding: 1.25rem;
    margin-bottom: 1rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border-left: 4px solid #663399;
    transition: all 0.3s ease;
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 1.25rem;
    align-items: center;
  }
  .training-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(102, 51, 153, 0.15);
  }
  .training-card.canceled {
    border-left-color: #dc3545;
    opacity: 0.7;
  }
  .training-card.full {
    border-left-color: #6c757d;
  }
  .training-card.hidden-by-filter {
    display: none !important;
  }
  body.dark-mode .training-card {
    background: #2a2a40;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }

  .training-date {
    text-align: center;
    min-width: 70px;
  }
  .training-date .day {
    font-size: 2rem;
    font-weight: 800;
    color: #663399;
    line-height: 1;
  }
  .training-date .month-year {
    font-size: 0.85rem;
    color: #6c757d;
    text-transform: uppercase;
  }
  .training-date .time {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    margin-top: 0.25rem;
  }
  body.dark-mode .training-date .day { color: #a855f7; }
  body.dark-mode .training-date .time { color: #f0f0f0; }

  .training-info h5 {
    margin: 0 0 0.5rem 0;
    font-weight: 600;
    color: #333;
  }
  body.dark-mode .training-info h5 { color: #f0f0f0; }

  .training-info .detail {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.25rem;
  }
  .training-info .detail i { color: #663399; width: 16px; }
  body.dark-mode .training-info .detail { color: #aaa; }
  body.dark-mode .training-info .detail i { color: #a855f7; }

  .training-volunteers {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    flex-wrap: wrap;
  }
  .volunteer-badge {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    color: #2e7d32;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.8rem;
    font-weight: 500;
  }
  .volunteer-empty {
    background: #f5f5f5;
    color: #999;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.8rem;
    border: 1px dashed #ccc;
  }
  body.dark-mode .volunteer-badge {
    background: linear-gradient(135deg, #1b5e20, #2e7d32);
    color: #a5d6a7;
  }
  body.dark-mode .volunteer-empty {
    background: #3a3a50;
    color: #888;
    border-color: #555;
  }

  .training-action {
    text-align: center;
  }
  .btn-signup {
    background: linear-gradient(135deg, #663399, #1e3c72);
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 2rem;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 51, 153, 0.3);
  }
  .btn-signup:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 51, 153, 0.4);
    color: white;
  }
  .btn-cancel {
    font-size: 0.8rem;
    margin-top: 0.5rem;
  }
  .status-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 1rem;
    font-weight: 500;
    font-size: 0.9rem;
  }
  .status-canceled {
    background: #ffebee;
    color: #c62828;
  }
  .status-full {
    background: #f5f5f5;
    color: #666;
  }
  body.dark-mode .status-canceled { background: #4a1c1c; color: #ef9a9a; }
  body.dark-mode .status-full { background: #3a3a50; color: #aaa; }

  /* No results */
  .no-results {
    text-align: center;
    padding: 3rem;
    color: #999;
  }
  .no-results i {
    font-size: 3rem;
    margin-bottom: 1rem;
    display: block;
  }

  /* Modal Improvements */
  .modal-content {
    border: none;
    border-radius: 1rem;
    overflow: hidden;
  }
  .modal-header {
    background: linear-gradient(135deg, #663399, #1e3c72);
    color: white;
    border: none;
    padding: 1.25rem 1.5rem;
  }
  .modal-header .btn-close {
    filter: brightness(0) invert(1);
  }
  .modal-title {
    font-weight: 700;
  }
  .modal-body {
    padding: 1.5rem;
  }
  .modal-footer {
    border: none;
    padding: 1rem 1.5rem 1.5rem;
  }
  .modal-footer .btn-primary {
    background: linear-gradient(135deg, #663399, #1e3c72);
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 2rem;
    font-weight: 600;
  }
  body.dark-mode .modal-content {
    background: #2a2a40;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .hero-banner { padding: 2.5rem 1rem; }
    .hero-banner h1 { font-size: 1.75rem; }
    .hero-banner p { font-size: 1rem; }
    .training-card {
      grid-template-columns: 1fr;
      text-align: center;
    }
    .training-date {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .training-volunteers { justify-content: center; }
    .month-tabs { justify-content: center; }
    .filters-card .row > div { margin-bottom: 0.75rem; }
  }
</style>
{% endblock %}
{% block content %}
<div class="container mt-4">
  <!-- Hero Banner -->
  <div class="hero-banner">
    <h1><i class="bi bi-heart-fill me-2"></i>Witaj, Wolontariuszu!</h1>
    <p>Dołącz do naszej drużyny i pomagaj osobom niewidomym w treningach Blind Tenisa. Wybierz termin poniżej i zapisz się!</p>
    <div class="hero-badge">
      <i class="bi bi-star-fill me-2"></i>
      Nie potrzebujesz doświadczenia – wszystkiego Cię nauczymy!
    </div>
  </div>

  <!-- Section Header -->
  <div class="section-header reveal-on-scroll">
    <h2><i class="bi bi-calendar-event me-2"></i>Nadchodzące treningi</h2>
  </div>

  <!-- Filters -->
  <div class="filters-card reveal-on-scroll">
    <div class="row align-items-end">
      <div class="col-md-3 col-6">
        <div class="filter-label"><i class="bi bi-geo-alt me-1"></i>Miejsce</div>
        <select id="filterLocation" class="form-select form-select-sm">
          <option value="">Wszystkie</option>
          {% set locations = [] %}
          {% for month, trainings in trainings_by_month.items() %}
            {% for training in trainings %}
              {% if training.location.name not in locations %}
                {% set _ = locations.append(training.location.name) %}
              {% endif %}
            {% endfor %}
          {% endfor %}
          {% for loc in locations|sort %}
            <option value="{{ loc }}">{{ loc }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3 col-6">
        <div class="filter-label"><i class="bi bi-person me-1"></i>Trener</div>
        <select id="filterTrainer" class="form-select form-select-sm">
          <option value="">Wszyscy</option>
          {% set trainers = [] %}
          {% for month, trainings in trainings_by_month.items() %}
            {% for training in trainings %}
              {% set trainer_name = training.coach.first_name ~ ' ' ~ training.coach.last_name %}
              {% if trainer_name not in trainers %}
                {% set _ = trainers.append(trainer_name) %}
              {% endif %}
            {% endfor %}
          {% endfor %}
          {% for trainer in trainers|sort %}
            <option value="{{ trainer }}">{{ trainer }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3 col-6">
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="filterHideFull">
          <label class="form-check-label" for="filterHideFull">
            <i class="bi bi-eye-slash me-1"></i>Ukryj zajęte
          </label>
        </div>
      </div>
      <div class="col-md-3 col-6 text-end">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="clearFilters">
          <i class="bi bi-x-circle me-1"></i>Wyczyść filtry
        </button>
      </div>
    </div>
  </div>

  <!-- Month Tabs -->
  <div class="month-tabs" role="tablist">
    {% set month_names = {'01': 'Styczeń', '02': 'Luty', '03': 'Marzec', '04': 'Kwiecień', '05': 'Maj', '06': 'Czerwiec', '07': 'Lipiec', '08': 'Sierpień', '09': 'Wrzesień', '10': 'Październik', '11': 'Listopad', '12': 'Grudzień'} %}
    {% for month, trainings in trainings_by_month.items() %}
      {% set year_month = month.split('-') %}
      {% set month_pl = month_names[year_month[1]] %}
      <button type="button" class="month-tab {% if loop.first %}active{% endif %}" 
              data-month="{{ month }}" role="tab" aria-selected="{{ 'true' if loop.first else 'false' }}">
        <i class="bi bi-calendar3"></i>
        {{ month_pl }} {{ year_month[0] }}
        <span class="count">{{ trainings|length }}</span>
      </button>
    {% endfor %}
  </div>

  <!-- Month Contents -->
  {% set month_names_short = {'01': 'sty', '02': 'lut', '03': 'mar', '04': 'kwi', '05': 'maj', '06': 'cze', '07': 'lip', '08': 'sie', '09': 'wrz', '10': 'paź', '11': 'lis', '12': 'gru'} %}
  {% for month, trainings in trainings_by_month.items() %}
    <div class="month-content {% if loop.first %}active{% endif %}" data-month="{{ month }}">
      {% for training in trainings %}
      {% set is_full = training.bookings|length >= 2 %}
      <div class="training-card {% if training.is_canceled %}canceled{% elif is_full %}full{% endif %}"
           data-location="{{ training.location.name }}"
           data-trainer="{{ training.coach.first_name }} {{ training.coach.last_name }}"
           data-full="{{ 'true' if is_full else 'false' }}">
        <div class="training-date">
          <div class="day">{{ training.date.strftime('%d') }}</div>
          <div class="month-year">{{ month_names_short[training.date.strftime('%m')] }} {{ training.date.strftime('%Y') }}</div>
          <div class="time"><i class="bi bi-clock me-1"></i>{{ training.date.strftime('%H:%M') }}</div>
        </div>

        <div class="training-info">
          <h5><i class="bi bi-geo-alt-fill me-2"></i>{{ training.location.name }}</h5>
          <div class="detail">
            <i class="bi bi-person-fill"></i>
            <span>{{ training.coach.first_name }} {{ training.coach.last_name }}</span>
          </div>
          <div class="detail">
            <i class="bi bi-telephone-fill"></i>
            <a href="tel:{{ training.coach.phone_number }}">{{ training.coach.phone_number|format_phone }}</a>
          </div>
          <div class="training-volunteers">
            {% for booking in training.bookings %}
              <span class="volunteer-badge"><i class="bi bi-person-check me-1"></i>{{ booking.volunteer.first_name }}</span>
            {% endfor %}
            {% for i in range(2 - training.bookings|length) %}
              <span class="volunteer-empty"><i class="bi bi-person-plus me-1"></i>Wolne miejsce</span>
            {% endfor %}
          </div>
        </div>

        <div class="training-action">
          {% if training.is_canceled %}
            <span class="status-badge status-canceled"><i class="bi bi-x-circle me-1"></i>Odwołany</span>
          {% elif training.bookings|length < 2 %}
            <button type="button" class="btn btn-signup" data-bs-toggle="modal" data-bs-target="#signupModal" data-training-id="{{ training.id }}">
              <i class="bi bi-pencil-square me-1"></i>Zapisz się
            </button>
            <div class="btn-cancel">
              <a href="{{ url_for('routes.cancel_booking', training_id=training.id) }}" class="text-muted"><i class="bi bi-x-circle me-1"></i>Wypisz się</a>
            </div>
          {% else %}
            <span class="status-badge status-full"><i class="bi bi-people-fill me-1"></i>Komplet</span>
            <div class="btn-cancel">
              <a href="{{ url_for('routes.cancel_booking', training_id=training.id) }}" class="text-muted"><i class="bi bi-x-circle me-1"></i>Wypisz się</a>
            </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
      <div class="no-results" style="display: none;">
        <i class="bi bi-search"></i>
        <p>Brak treningów spełniających kryteria filtrowania</p>
      </div>
    </div>
  {% endfor %}
</div>

<!-- Modal for volunteer sign-up -->
<div class="modal fade" id="signupModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post">
        {{ form.csrf_token }}
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-person-plus-fill me-2"></i>Zapisz się na trening</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            {{ form.first_name.label(class="form-label fw-semibold") }}
            {{ form.first_name(class="form-control form-control-lg", placeholder="Twoje imię") }}
          </div>
          <div class="mb-3">
            {{ form.last_name.label(class="form-label fw-semibold") }}
            {{ form.last_name(class="form-control form-control-lg", placeholder="Twoje nazwisko") }}
          </div>
          <div class="mb-3">
            {{ form.email.label(class="form-label fw-semibold") }}
            {{ form.email(class="form-control form-control-lg", placeholder="twoj@email.pl") }}
          </div>
          <div class="mb-3">
            {{ form.phone_number.label(class="form-label fw-semibold") }}
            {{ form.phone_number(class="form-control form-control-lg", placeholder="np. 500 600 700") }}
          </div>
          <div class="mb-3">
            {{ form.is_adult.label(class="form-label fw-semibold d-block") }}
            {% for subfield in form.is_adult %}
            <div class="form-check">
              {{ subfield(class="form-check-input", id=subfield.id) }}
              <label class="form-check-label" for="{{ subfield.id }}">{{ subfield.label.text }}</label>
            </div>
            {% endfor %}
          </div>
          <div class="mb-3 form-check">
            {{ form.privacy_consent(class="form-check-input") }}
            <label class="form-check-label" for="{{ form.privacy_consent.id }}">{{ form.privacy_consent.label.text|safe }}</label>
          </div>
          {{ form.training_id }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Anuluj</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>Zapisz się</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Modal training ID
    var signupModal = document.getElementById('signupModal');
    signupModal.addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget;
      var trainingId = button.getAttribute('data-training-id');
      signupModal.querySelector('input[name="training_id"]').value = trainingId;
    });

    // Month tabs
    var monthTabs = document.querySelectorAll('.month-tab');
    var monthContents = document.querySelectorAll('.month-content');
    
    monthTabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        var month = this.getAttribute('data-month');
        
        // Update tabs
        monthTabs.forEach(function(t) {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
        });
        this.classList.add('active');
        this.setAttribute('aria-selected', 'true');
        
        // Update content
        monthContents.forEach(function(content) {
          content.classList.remove('active');
          if (content.getAttribute('data-month') === month) {
            content.classList.add('active');
          }
        });
        
        // Re-apply filters
        applyFilters();
      });
    });

    // Filters
    var filterLocation = document.getElementById('filterLocation');
    var filterTrainer = document.getElementById('filterTrainer');
    var filterHideFull = document.getElementById('filterHideFull');
    var clearFiltersBtn = document.getElementById('clearFilters');

    function applyFilters() {
      var location = filterLocation.value;
      var trainer = filterTrainer.value;
      var hideFull = filterHideFull.checked;
      
      document.querySelectorAll('.month-content').forEach(function(content) {
        var cards = content.querySelectorAll('.training-card');
        var visibleCount = 0;
        
        cards.forEach(function(card) {
          var matchLocation = !location || card.getAttribute('data-location') === location;
          var matchTrainer = !trainer || card.getAttribute('data-trainer') === trainer;
          var isFull = card.getAttribute('data-full') === 'true';
          var matchFull = !hideFull || !isFull;
          
          if (matchLocation && matchTrainer && matchFull) {
            card.classList.remove('hidden-by-filter');
            visibleCount++;
          } else {
            card.classList.add('hidden-by-filter');
          }
        });
        
        // Show/hide no results message
        var noResults = content.querySelector('.no-results');
        if (noResults) {
          noResults.style.display = visibleCount === 0 ? 'block' : 'none';
        }
      });
      
      // Update tab counts
      updateTabCounts();
    }
    
    function updateTabCounts() {
      monthTabs.forEach(function(tab) {
        var month = tab.getAttribute('data-month');
        var content = document.querySelector('.month-content[data-month="' + month + '"]');
        var visibleCards = content.querySelectorAll('.training-card:not(.hidden-by-filter)').length;
        var countSpan = tab.querySelector('.count');
        countSpan.textContent = visibleCards;
      });
    }

    filterLocation.addEventListener('change', applyFilters);
    filterTrainer.addEventListener('change', applyFilters);
    filterHideFull.addEventListener('change', applyFilters);
    
    clearFiltersBtn.addEventListener('click', function() {
      filterLocation.value = '';
      filterTrainer.value = '';
      filterHideFull.checked = false;
      applyFilters();
    });
  });
</script>
{% endblock %}
